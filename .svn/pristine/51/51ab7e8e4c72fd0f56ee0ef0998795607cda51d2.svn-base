//
//  UMengShareFactory.m
//  Pods-XCShareManager_Example
//
//  Created by æ¨Šå°èª on 2017/11/6.
//

#import "UMengShareFactory.h"
#import "UMengShare.h"
#import "XCShareUI.h"

#import <UMSocialCore/UMSocialCore.h>


@interface UMengShareFactory ()

@property (copy, nonatomic) NSString *appKey;
@property (strong, nonatomic) UIImage *appIcon;

@property (strong, nonatomic) XCShareUI *shareUI;

@end


@implementation UMengShareFactory

#pragma mark - ğŸ‘€ XCShareFactoryProtocol ğŸ‘€ ğŸ’¤

/**
 *  æ ¹æ® AppKey åˆ›å»ºåˆ†äº«å·¥å‚å®ä½“
 */
- (instancetype)initWithAppKey:(NSString *)appKey
                       appIcon:(UIImage *)appIcon
            platformConfigures:(NSArray<XCSharePlatformConfigure *> *)configures
{
    if (self = [super init])
    {
        self.appKey  = appKey;
        self.appIcon = appIcon;
        
        // é…ç½®åˆ†äº«å¹³å°
        [self configurePlatformConfigures:configures];
    }
    
    return self;
}

- (id<XCShareProtocol>)share
{
    return [[UMengShare alloc] initWithShareUI:self.shareUI appIcon:self.appIcon];
}

#pragma mark - ğŸ”’ ğŸ‘€ Privite Method ğŸ‘€

- (void)configurePlatformConfigures:(NSArray<XCSharePlatformConfigure *> *)configures
{
    /// é…ç½®åˆ†äº« AppKey
    [self configureAppKey:configures];
    
    /// é…ç½® åˆ†äº« UI
    [self configureUI:configures];
}

/**
 *  é…ç½®åˆ†äº« AppKey
 */
- (void)configureAppKey:(NSArray<XCSharePlatformConfigure *> *)configures
{
    // Override point for customization after application launch.
    //æ‰“å¼€æ—¥å¿—
    [[UMSocialManager defaultManager] openLog:YES];
    //è®¾ç½®å‹ç›Ÿappkey
    [[UMSocialManager defaultManager] setUmSocialAppkey:self.appKey];
    
    // è·å–å‹ç›Ÿsocialç‰ˆæœ¬å·
    NSLog(@"UMeng social version: %@", [UMSocialGlobal umSocialSDKVersion]);
    
    /// é…ç½®åˆ†äº« å¹³å°å‚æ•°
    [configures enumerateObjectsUsingBlock:^(XCSharePlatformConfigure * _Nonnull config, NSUInteger idx, BOOL * _Nonnull stop) {
        
        // å‹ç›Ÿåˆ†äº«å¹³å°
        UMSocialPlatformType platformType;
        
        switch (config.platformType)
        {
            case XCSharePlatformTypeQQ:
            {
                platformType = UMSocialPlatformType_QQ;     // QQå¥½å‹
                break;
            }
            case XCSharePlatformTypeQQZone:
            {
                platformType = UMSocialPlatformType_Qzone;  // QQç©ºé—´
                break;
            }
            case XCSharePlatformTypeWechat:
            {
                platformType = UMSocialPlatformType_WechatSession;  // å¾®ä¿¡å¥½å‹
                break;
            }
            case XCSharePlatformTypeWechatTimeLine:
            {
                platformType = UMSocialPlatformType_WechatTimeLine; // å¾®ä¿¡æœ‹å‹åœˆ
                break;
            }
            case XCSharePlatformTypeSina:
            {
                platformType = UMSocialPlatformType_Sina;       // æ–°æµª
                break;
            }
        }
        
        // å„å¹³å°çš„è¯¦ç»†é…ç½®
        [[UMSocialManager defaultManager] setPlaform:platformType
                                              appKey:config.appId
                                           appSecret:config.appSecret
                                         redirectURL:config.appRedirectURL];
    }];
}

/**
 *  é…ç½® åˆ†äº« UI
 */
- (void)configureUI:(NSArray<XCSharePlatformConfigure *> *)configures
{
    /// é…ç½® åˆ†äº« UI
    self.shareUI = [[XCShareUI alloc] init];
    
    __weak typeof(self)weakSelf = self;
    
    [self.shareUI setupShareUIWithConfigures:configures didClickItemHandle:^(XCSharePlatformType platformType) {
        
        // å‹ç›Ÿåˆ†äº«
        UMengShare *share = weakSelf.share;
        
        // ç‚¹å‡»åˆ†äº« item çš„å›è°ƒ
        [share clickItemAction:platformType];
    }];
}

@end
